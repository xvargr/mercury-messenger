{"ast":null,"code":"import _objectSpread from\"/home/agreus/Documents/webdev/mercury-messenger/client/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/home/agreus/Documents/webdev/mercury-messenger/client/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{useState,createContext,useContext,useEffect,useRef}from\"react\";import{useNavigate}from\"react-router-dom\";import{io}from\"socket.io-client\";// context\nimport{FlashContext}from\"./FlashContext\";import{DataContext}from\"./DataContext\";// utility hooks\nimport axiosInstance from\"../../utils/axios\";// config\nimport config from\"../../config\";import{jsx as _jsx}from\"react/jsx-runtime\";export var SocketContext=/*#__PURE__*/createContext();export function SocketStateProvider(props){var _useState=useState(null),_useState2=_slicedToArray(_useState,2),socket=_useState2[0],setSocket=_useState2[1];var _useState3=useState({connected:false,message:null,code:null}),_useState4=_slicedToArray(_useState3,2),socketStatus=_useState4[0],setSocketStatus=_useState4[1];var _useContext=useContext(FlashContext),pushFlashMessage=_useContext.pushFlashMessage;var _useContext2=useContext(DataContext),windowIsFocused=_useContext2.windowIsFocused,selectedChannel=_useContext2.selectedChannel,selectedGroup=_useContext2.selectedGroup,setSelectedChannel=_useContext2.setSelectedChannel,setSelectedGroup=_useContext2.setSelectedGroup,clearSelected=_useContext2.clearSelected,setGroupData=_useContext2.setGroupData,setChatMounted=_useContext2.setChatMounted,dataMounted=_useContext2.dataMounted,setDataMounted=_useContext2.setDataMounted,mountChat=_useContext2.mountChat,setPeerData=_useContext2.setPeerData,dataHelpers=_useContext2.dataHelpers,isLoggedIn=_useContext2.isLoggedIn,setIsLoggedIn=_useContext2.setIsLoggedIn,setStatusForced=_useContext2.setStatusForced,peerHelpers=_useContext2.peerHelpers,setSocketError=_useContext2.setSocketError;var _axiosInstance=axiosInstance(),userGroups=_axiosInstance.userGroups;// these refs are used to provide the latest values and fix stale closures in socket events\nvar selectedGroupRef=useRef(selectedGroup);var selectedChannelRef=useRef(selectedChannel);useEffect(function(){selectedGroupRef.current=selectedGroup;selectedChannelRef.current=selectedChannel;},[selectedGroup,selectedChannel]);var navigate=useNavigate();var notification=new Audio(\"/beep.mp3\");// initial socket io connection\nuseEffect(function(){if(isLoggedIn&&!socketStatus.connected){connectSocket();}return function(){socket===null||socket===void 0?void 0:socket.disconnect();setSocketStatus({connected:false,message:null,code:null});};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[isLoggedIn,dataMounted]);function connectSocket(){setSocket(io(config.ORIGIN,{withCredentials:true}));}function socketClear(){if(socket!==null)socket.disconnect();setSocket(null);setSocketStatus({connected:true,message:null,code:null});}// this should only run once to avoid multiple instances of socket event listeners\n// this check avoids duplicate listeners\n// stale closure issue here, solved with refs, alternatively if in useEffect, ensure proper dependencies\nif(socket&&!(socket!==null&&socket!==void 0&&socket._callbacks)){socket.on(\"connect\",function/*don't redefine socket here*/(){// \"connect\" not \"connected\"\nuserGroups.fetch().then(function(res){var groupData=res.data;setGroupData(function(){return groupData;});socket.emit(\"requestInitData\",{},function(res,err){if(err||res.failed)return err;else{setPeerData(res.peerData);if(res.peerData[localStorage.userId].status!==\"online\"){setStatusForced(true);}mountChat(res.chatData,res.chatDepleted);}});setSocketError(null);setDataMounted(true);}).catch(function(e){return e;});// axios abort throws error unless it's caught here\nsetSocketStatus({connected:true,code:null,message:null});});socket.on(\"disconnect\",function(res){if(res===\"transport close\"){setSocketError(\"server unavailable\");}else if(res===\"io server disconnect\"){setSocketError(\"click to use on this device\");}setChatMounted(false);setSocketStatus({connected:false,code:503,message:null});});socket.on(\"connect_error\",function(err){if(err.message===\"xhr poll error\"){setSocketStatus({connected:false,message:\"Server unreachable\",code:503});}else if(err.data.code===403){setSocketStatus({connected:false,message:err.data.message,code:err.data.code});}else if(err.data.code===401){setIsLoggedIn(false);}});socket.on(\"newMessage\",function(res){var _selectedChannelRef$c;var channelIsFocused=((_selectedChannelRef$c=selectedChannelRef.current)===null||_selectedChannelRef$c===void 0?void 0:_selectedChannelRef$c._id)===res.channel._id;if(!windowIsFocused||!channelIsFocused){notification.play();}if(!channelIsFocused){dataHelpers.setUnread({add:true,channelId:res.channel._id});}setGroupData(function(prevData){var dataCopy=_objectSpread({},prevData);dataCopy[res.group._id].chatData[res.channel._id].push(res);return dataCopy;});});socket.on(\"appendMessage\",function(res){var _selectedChannelRef$c2;var channelIsFocused=((_selectedChannelRef$c2=selectedChannelRef.current)===null||_selectedChannelRef$c2===void 0?void 0:_selectedChannelRef$c2._id)===res.target.channel;if(windowIsFocused||!channelIsFocused){notification.play();}setGroupData(function(prevStack){var dataCopy=_objectSpread({},prevStack);var stackCopy=dataCopy[res.target.group].chatData[res.target.channel];var clusterIndex=stackCopy.findIndex(function(cluster){return cluster._id===res.target.cluster.id;});// update stack to contain verified message\nstackCopy[clusterIndex].content[res.target.index]=res.data;// update mentions\nif(res.data.mentions.length>0){var mentionsCopy=stackCopy[clusterIndex].mentions;// add new mentions if has not been mentioned before\nres.data.mentions.forEach(function(user){var isNotMentioned=!mentionsCopy.some(function(existingUser){return existingUser._id===user._id;});if(isNotMentioned){mentionsCopy.push(user);}});}dataCopy[res.target.group].chatData[res.target.channel]=stackCopy;return dataCopy;});});socket.on(\"structureChange\",function(res){var target=res.target,change=res.change,messages=res.messages;// console.log(selectedGroup);\n// console.log(`${change.type} signal received`);\n// console.log(res);\nfunction createChannel(){setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);dataCopy[target.parent].channels.text.push(change.data);dataCopy[target.parent].chatData[target.id]=[];return dataCopy;});}function editChannel(){var _selectedChannelRef$c3;setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);var channelIndex=dataHelpers.getChannelIndex(target.parent,target.id);dataCopy[target.parent].channels.text[channelIndex]=change.data;return dataCopy;});if(((_selectedChannelRef$c3=selectedChannelRef.current)===null||_selectedChannelRef$c3===void 0?void 0:_selectedChannelRef$c3._id)===target.id){setSelectedChannel(change.data);navigate(\"/g/\".concat(selectedGroupRef.current.name,\"/c/\").concat(change.data.name));}}function deleteChannel(){var _selectedChannelRef$c4;setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);var channelIndex=dataHelpers.getChannelIndex(target.parent,target.id);dataCopy[target.parent].channels.text.splice(channelIndex,1);delete dataCopy[target.parent].chatData[target.id];return dataCopy;});if(((_selectedChannelRef$c4=selectedChannelRef.current)===null||_selectedChannelRef$c4===void 0?void 0:_selectedChannelRef$c4._id)===target.id){setSelectedChannel(null);navigate(\"/g/\".concat(selectedGroupRef.current.name));}}function createGroup(){setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);dataCopy.push(change.data);dataCopy[target.parent].chatData[target.id]=[];return dataCopy;});}function editGroup(){var _change$extra,_change$extra$toKick,_selectedGroupRef$cur;var isKicked=(_change$extra=change.extra)===null||_change$extra===void 0?void 0:(_change$extra$toKick=_change$extra.toKick)===null||_change$extra$toKick===void 0?void 0:_change$extra$toKick.includes(localStorage.userId);setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);if(isKicked)delete dataCopy[target.id];else{// move old chat to new group\nvar chatCopy=dataCopy[target.id].chatData;dataCopy[target.id]=change.data;dataCopy[target.id].chatData=chatCopy;}return dataCopy;});if(((_selectedGroupRef$cur=selectedGroupRef.current)===null||_selectedGroupRef$cur===void 0?void 0:_selectedGroupRef$cur._id)===target.id){if(isKicked){setSelectedGroup(null);setSelectedChannel(null);navigate(\"/\");}else{setSelectedGroup(change.data);// reroute to updated, depending on if in channel\nif(selectedChannelRef.current){navigate(\"/g/\".concat(change.data.name,\"/c/\").concat(selectedChannelRef.current.name));}else{navigate(\"/g/\".concat(change.data.name));}}}}function deleteGroup(){var _selectedGroupRef$cur2;setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);delete dataCopy[target.id];return dataCopy;});if(((_selectedGroupRef$cur2=selectedGroupRef.current)===null||_selectedGroupRef$cur2===void 0?void 0:_selectedGroupRef$cur2._id)===target.id){clearSelected();navigate(\"/\");}}function joinedGroup(){setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);dataCopy[target.id].members.push(change.extra.user);return dataCopy;});dataHelpers.mergePeers(change.extra.partialPeerData);}function leftGroup(params){setGroupData(function(currentData){var dataCopy=_objectSpread({},currentData);dataCopy[target.id].members=dataCopy[target.id].members.filter(function(member){return member._id!==change.extra.userId;});dataCopy[target.id].administrators=dataCopy[target.id].members.filter(function(admin){return admin._id!==change.extra.userId;});return dataCopy;});}// function editMessage() {} // todo\n// function deleteMessage() {} // todo\nif(messages.length>0)pushFlashMessage(messages);// transfer any messages to context\nif(target.type===\"channel\"){if(change.type===\"create\")createChannel();else if(change.type===\"edit\")editChannel();else if(change.type===\"delete\")deleteChannel();}else if(target.type===\"group\"){if(change.type===\"create\")createGroup();else if(change.type===\"edit\")editGroup();else if(change.type===\"delete\")deleteGroup();else if(change.type===\"join\")joinedGroup();else if(change.type===\"leave\")leftGroup();}// else if (target.type === \"message\") {\n//   if (change.type === \"edit\") editMessage();\n//   else if (change.type === \"delete\") deleteMessage();\n// }\n});socket.on(\"statusChange\",function(res){peerHelpers.changeStatus({target:res.target,change:res.change});});}var socketInstance={socket:socket,connectSocket:connectSocket,socketStatus:socketStatus,socketClear:socketClear};return/*#__PURE__*/_jsx(SocketContext.Provider,{value:socketInstance,children:props.children});}","map":{"version":3,"names":["useState","createContext","useContext","useEffect","useRef","useNavigate","io","FlashContext","DataContext","axiosInstance","config","SocketContext","SocketStateProvider","props","socket","setSocket","connected","message","code","socketStatus","setSocketStatus","pushFlashMessage","windowIsFocused","selectedChannel","selectedGroup","setSelectedChannel","setSelectedGroup","clearSelected","setGroupData","setChatMounted","dataMounted","setDataMounted","mountChat","setPeerData","dataHelpers","isLoggedIn","setIsLoggedIn","setStatusForced","peerHelpers","setSocketError","userGroups","selectedGroupRef","selectedChannelRef","current","navigate","notification","Audio","connectSocket","disconnect","ORIGIN","withCredentials","socketClear","_callbacks","on","fetch","then","res","groupData","data","emit","err","failed","peerData","localStorage","userId","status","chatData","chatDepleted","catch","e","channelIsFocused","_id","channel","play","setUnread","add","channelId","prevData","dataCopy","group","push","target","prevStack","stackCopy","clusterIndex","findIndex","cluster","id","content","index","mentions","length","mentionsCopy","forEach","user","isNotMentioned","some","existingUser","change","messages","createChannel","currentData","parent","channels","text","editChannel","channelIndex","getChannelIndex","name","deleteChannel","splice","createGroup","editGroup","isKicked","extra","toKick","includes","chatCopy","deleteGroup","joinedGroup","members","mergePeers","partialPeerData","leftGroup","params","filter","member","administrators","admin","type","changeStatus","socketInstance","children"],"sources":["/home/agreus/Documents/webdev/mercury-messenger/client/src/components/context/SocketContext.js"],"sourcesContent":["import { useState, createContext, useContext, useEffect, useRef } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { io } from \"socket.io-client\";\n\n// context\nimport { FlashContext } from \"./FlashContext\";\nimport { DataContext } from \"./DataContext\";\n\n// utility hooks\nimport axiosInstance from \"../../utils/axios\";\n\n// config\nimport config from \"../../config\";\n\nexport const SocketContext = createContext();\n\nexport function SocketStateProvider(props) {\n  const [socket, setSocket] = useState(null);\n  const [socketStatus, setSocketStatus] = useState({\n    connected: false,\n    message: null,\n    code: null,\n  });\n  const { pushFlashMessage } = useContext(FlashContext);\n\n  const {\n    windowIsFocused,\n    selectedChannel,\n    selectedGroup,\n    setSelectedChannel,\n    setSelectedGroup,\n    clearSelected,\n    setGroupData,\n    setChatMounted,\n    dataMounted,\n    setDataMounted,\n    mountChat,\n    setPeerData,\n    dataHelpers,\n    isLoggedIn,\n    setIsLoggedIn,\n    setStatusForced,\n    peerHelpers,\n    setSocketError,\n  } = useContext(DataContext);\n\n  const { userGroups } = axiosInstance();\n\n  // these refs are used to provide the latest values and fix stale closures in socket events\n  const selectedGroupRef = useRef(selectedGroup);\n  const selectedChannelRef = useRef(selectedChannel);\n  useEffect(() => {\n    selectedGroupRef.current = selectedGroup;\n    selectedChannelRef.current = selectedChannel;\n  }, [selectedGroup, selectedChannel]);\n\n  const navigate = useNavigate();\n  const notification = new Audio(\"/beep.mp3\");\n\n  // initial socket io connection\n  useEffect(() => {\n    if (isLoggedIn && !socketStatus.connected) {\n      connectSocket();\n    }\n    return () => {\n      socket?.disconnect();\n      setSocketStatus({\n        connected: false,\n        message: null,\n        code: null,\n      });\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isLoggedIn, dataMounted]);\n\n  function connectSocket() {\n    setSocket(\n      io(config.ORIGIN, {\n        withCredentials: true,\n      })\n    );\n  }\n\n  function socketClear() {\n    if (socket !== null) socket.disconnect();\n    setSocket(null);\n    setSocketStatus({ connected: true, message: null, code: null });\n  }\n\n  // this should only run once to avoid multiple instances of socket event listeners\n  // this check avoids duplicate listeners\n  // stale closure issue here, solved with refs, alternatively if in useEffect, ensure proper dependencies\n  if (socket && !socket?._callbacks) {\n    socket.on(\"connect\", function (/*don't redefine socket here*/) {\n      // \"connect\" not \"connected\"\n\n      userGroups\n        .fetch()\n        .then((res) => {\n          const groupData = res.data;\n\n          setGroupData(() => groupData);\n\n          socket.emit(\"requestInitData\", {}, (res, err) => {\n            if (err || res.failed) return err;\n            else {\n              setPeerData(res.peerData);\n              if (res.peerData[localStorage.userId].status !== \"online\") {\n                setStatusForced(true);\n              }\n              mountChat(res.chatData, res.chatDepleted);\n            }\n          });\n\n          setSocketError(null);\n          setDataMounted(true);\n        })\n        .catch((e) => e); // axios abort throws error unless it's caught here\n\n      setSocketStatus({ connected: true, code: null, message: null });\n    });\n\n    socket.on(\"disconnect\", (res) => {\n      if (res === \"transport close\") {\n        setSocketError(\"server unavailable\");\n      } else if (res === \"io server disconnect\") {\n        setSocketError(\"click to use on this device\");\n      }\n\n      setChatMounted(false);\n      setSocketStatus({ connected: false, code: 503, message: null });\n    });\n\n    socket.on(\"connect_error\", (err) => {\n      if (err.message === \"xhr poll error\") {\n        setSocketStatus({\n          connected: false,\n          message: \"Server unreachable\",\n          code: 503,\n        });\n      } else if (err.data.code === 403) {\n        setSocketStatus({\n          connected: false,\n          message: err.data.message,\n          code: err.data.code,\n        });\n      } else if (err.data.code === 401) {\n        setIsLoggedIn(false);\n      }\n    });\n\n    socket.on(\"newMessage\", function (res) {\n      const channelIsFocused =\n        selectedChannelRef.current?._id === res.channel._id;\n\n      if (!windowIsFocused || !channelIsFocused) {\n        notification.play();\n      }\n\n      if (!channelIsFocused) {\n        dataHelpers.setUnread({ add: true, channelId: res.channel._id });\n      }\n\n      setGroupData((prevData) => {\n        const dataCopy = { ...prevData };\n\n        dataCopy[res.group._id].chatData[res.channel._id].push(res);\n        return dataCopy;\n      });\n    });\n\n    socket.on(\"appendMessage\", function (res) {\n      const channelIsFocused =\n        selectedChannelRef.current?._id === res.target.channel;\n\n      if (windowIsFocused || !channelIsFocused) {\n        notification.play();\n      }\n\n      setGroupData((prevStack) => {\n        const dataCopy = { ...prevStack };\n        const stackCopy =\n          dataCopy[res.target.group].chatData[res.target.channel];\n\n        const clusterIndex = stackCopy.findIndex(\n          (cluster) => cluster._id === res.target.cluster.id\n        );\n\n        // update stack to contain verified message\n        stackCopy[clusterIndex].content[res.target.index] = res.data;\n\n        // update mentions\n        if (res.data.mentions.length > 0) {\n          const mentionsCopy = stackCopy[clusterIndex].mentions;\n\n          // add new mentions if has not been mentioned before\n          res.data.mentions.forEach((user) => {\n            const isNotMentioned = !mentionsCopy.some(\n              (existingUser) => existingUser._id === user._id\n            );\n\n            if (isNotMentioned) {\n              mentionsCopy.push(user);\n            }\n          });\n        }\n\n        dataCopy[res.target.group].chatData[res.target.channel] = stackCopy;\n\n        return dataCopy;\n      });\n    });\n\n    socket.on(\"structureChange\", function (res) {\n      const { target, change, messages } = res;\n\n      // console.log(selectedGroup);\n      // console.log(`${change.type} signal received`);\n      // console.log(res);\n\n      function createChannel() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n\n          dataCopy[target.parent].channels.text.push(change.data);\n          dataCopy[target.parent].chatData[target.id] = [];\n          return dataCopy;\n        });\n      }\n\n      function editChannel() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n          const channelIndex = dataHelpers.getChannelIndex(\n            target.parent,\n            target.id\n          );\n\n          dataCopy[target.parent].channels.text[channelIndex] = change.data;\n          return dataCopy;\n        });\n\n        if (selectedChannelRef.current?._id === target.id) {\n          setSelectedChannel(change.data);\n          navigate(`/g/${selectedGroupRef.current.name}/c/${change.data.name}`);\n        }\n      }\n\n      function deleteChannel() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n          const channelIndex = dataHelpers.getChannelIndex(\n            target.parent,\n            target.id\n          );\n\n          dataCopy[target.parent].channels.text.splice(channelIndex, 1);\n          delete dataCopy[target.parent].chatData[target.id];\n\n          return dataCopy;\n        });\n\n        if (selectedChannelRef.current?._id === target.id) {\n          setSelectedChannel(null);\n          navigate(`/g/${selectedGroupRef.current.name}`);\n        }\n      }\n\n      function createGroup() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n          dataCopy.push(change.data);\n          dataCopy[target.parent].chatData[target.id] = [];\n          return dataCopy;\n        });\n      }\n\n      function editGroup() {\n        const isKicked = change.extra?.toKick?.includes(localStorage.userId);\n\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n\n          if (isKicked) delete dataCopy[target.id];\n          else {\n            // move old chat to new group\n            const chatCopy = dataCopy[target.id].chatData;\n            dataCopy[target.id] = change.data;\n            dataCopy[target.id].chatData = chatCopy;\n          }\n\n          return dataCopy;\n        });\n\n        if (selectedGroupRef.current?._id === target.id) {\n          if (isKicked) {\n            setSelectedGroup(null);\n            setSelectedChannel(null);\n            navigate(\"/\");\n          } else {\n            setSelectedGroup(change.data);\n\n            // reroute to updated, depending on if in channel\n            if (selectedChannelRef.current) {\n              navigate(\n                `/g/${change.data.name}/c/${selectedChannelRef.current.name}`\n              );\n            } else {\n              navigate(`/g/${change.data.name}`);\n            }\n          }\n        }\n      }\n\n      function deleteGroup() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n          delete dataCopy[target.id];\n          return dataCopy;\n        });\n\n        if (selectedGroupRef.current?._id === target.id) {\n          clearSelected();\n          navigate(`/`);\n        }\n      }\n\n      function joinedGroup() {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n          dataCopy[target.id].members.push(change.extra.user);\n          return dataCopy;\n        });\n        dataHelpers.mergePeers(change.extra.partialPeerData);\n      }\n\n      function leftGroup(params) {\n        setGroupData((currentData) => {\n          const dataCopy = { ...currentData };\n\n          dataCopy[target.id].members = dataCopy[target.id].members.filter(\n            (member) => member._id !== change.extra.userId\n          );\n\n          dataCopy[target.id].administrators = dataCopy[\n            target.id\n          ].members.filter((admin) => admin._id !== change.extra.userId);\n\n          return dataCopy;\n        });\n      }\n\n      // function editMessage() {} // todo\n\n      // function deleteMessage() {} // todo\n\n      if (messages.length > 0) pushFlashMessage(messages); // transfer any messages to context\n\n      if (target.type === \"channel\") {\n        if (change.type === \"create\") createChannel();\n        else if (change.type === \"edit\") editChannel();\n        else if (change.type === \"delete\") deleteChannel();\n      } else if (target.type === \"group\") {\n        if (change.type === \"create\") createGroup();\n        else if (change.type === \"edit\") editGroup();\n        else if (change.type === \"delete\") deleteGroup();\n        else if (change.type === \"join\") joinedGroup();\n        else if (change.type === \"leave\") leftGroup();\n      }\n      // else if (target.type === \"message\") {\n      //   if (change.type === \"edit\") editMessage();\n      //   else if (change.type === \"delete\") deleteMessage();\n      // }\n    });\n\n    socket.on(\"statusChange\", (res) => {\n      peerHelpers.changeStatus({ target: res.target, change: res.change });\n    });\n  }\n\n  const socketInstance = {\n    socket,\n    connectSocket,\n    socketStatus,\n    socketClear,\n  };\n\n  return (\n    <SocketContext.Provider value={socketInstance}>\n      {props.children}\n    </SocketContext.Provider>\n  );\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}